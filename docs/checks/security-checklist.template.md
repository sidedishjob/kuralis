# セキュリティ脆弱性チェックテンプレート（Supabase + Next.js向け）

⚠️ **このファイルはテンプレートです。絶対に直接編集しないでください。**  
✅ **チェック実施時はこのファイルをコピーして、`security-checklist.YYYY-MM-DD.md` のような名前で保存してください。**

このテンプレートは、Supabase + Next.js アプリケーションにおける基本的なセキュリティ対策が適切に実装されているかを確認するためのチェックリストです。

## セキュリティチェックシート

| No. | 項目                           | 確認内容                                                                   | 目的             |
| --- | ------------------------------ | -------------------------------------------------------------------------- | ---------------- |
| 1   | 認証フローの保護               | 未認証ユーザーが保護ページへアクセスできないよう制御されているか？         | 認可バイパス防止 |
| 2   | Supabase RLSの適用             | 全てのテーブルにRow Level Security（RLS）が有効になっているか？            | データ漏洩防止   |
| 3   | Service Role Keyの管理         | `SUPABASE_SERVICE_ROLE_KEY` がAPI経由で絶対に漏れない構成になっているか？  | 秘匿情報保護     |
| 4   | APIレスポンスの情報漏洩防止    | 不要なエラーメッセージやスタックトレースがクライアントに返されていないか？ | 情報漏洩対策     |
| 5   | JWT保存先                      | トークンがCookieかSecureなStorageに保存されているか？                      | セッション保護   |
| 6   | SupabaseのログインRedirect制御 | OAuthなどのリダイレクト先が正規URLでホワイトリスト管理されているか？       | フィッシング防止 |
| 7   | `.env`とGitの管理              | `.env`が `.gitignore` に含まれており、Gitにpushされていないか？            | 環境情報保護     |
| 8   | `npm audit` の対応             | `npm audit` で高・重大な脆弱性がないか？                                   | 依存の安全性     |
| 9   | セキュリティHeaderの設定       | `next.config.js` またはミドルウェアでCSPやHSTSなどが設定されているか？     | ブラウザ保護     |
| 10  | Supabase Storageの公開範囲     | ストレージバケットのアクセスが必要最小限の権限に制限されているか？         | ファイル漏洩防止 |

## セキュリティチェック：進捗管理

| No. | チェック項目                | 状態      | チェック内容                         | 判定      | 備考・修正指示 |
| --- | --------------------------- | --------- | ------------------------------------ | --------- | -------------- |
| 1   | 認証フローの保護            | ⬜ 未実施 | 未認証ユーザーのページアクセス制御   | ❓ 未確認 |                |
| 2   | Supabase RLSの適用          | ⬜ 未実施 | 全テーブルにRLS適用                  | ❓ 未確認 |                |
| 3   | Service Role Keyの管理      | ⬜ 未実施 | 環境変数の公開漏洩チェック           | ❓ 未確認 |                |
| 4   | APIレスポンスの情報漏洩防止 | ⬜ 未実施 | エラーハンドリングの適切性           | ❓ 未確認 |                |
| 5   | JWT保存先                   | ⬜ 未実施 | Cookie/Storageの安全な管理           | ❓ 未確認 |                |
| 6   | Supabaseのリダイレクト制御  | ⬜ 未実施 | OAuth後の遷移先の安全性              | ❓ 未確認 |                |
| 7   | `.env`とGitの管理           | ⬜ 未実施 | `.env` の漏洩確認                    | ❓ 未確認 |                |
| 8   | `npm audit` の対応          | ⬜ 未実施 | 依存パッケージの脆弱性対応           | ❓ 未確認 |                |
| 9   | セキュリティHeaderの設定    | ⬜ 未実施 | CSP, HSTS, X-Frame-Optionsなどの有無 | ❓ 未確認 |                |
| 10  | Supabase Storageの公開範囲  | ⬜ 未実施 | ストレージバケットのパブリック設定   | ❓ 未確認 |                |

---

## 実施方法

### 確認方法

- 状態カラム：
  ⬜ 未実施 → 🟡 実施中 → ✅ 完了
- 判定カラム：
  ❓ 未確認、✅ 問題なし、⚠️ 部分的、❌ 要修正
- 備考に分析コメントや修正指示を記録
- 毎チェックごとにこの表を1項目ずつ更新していく

---

## チェック対象ファイル一覧（チェック実施時に記入）

- `middleware.ts`
- `lib/supabase/admin.ts`
- `lib/supabase/server.ts`
- `app/api/**/route.ts`
- `.env.local`

---

## 総合評価（チェック実施後に記入）

セキュリティ実装度: （例：優秀 / 良好 / 要改善） (xx/10項目 問題なし)

---

## 優れている点（自由記述）

- （例）すべてのテーブルにRLSが適用されていた
- （例）Service Role KeyがAPIからアクセス不能な構成
- （例）Supabase Storageが完全に非公開

---

## 指摘事項・改善点（必要があれば記入）

- （例）OAuthリダイレクト先にワイルドカードが設定されていた
- （例）`.env.local` が `.gitignore` に含まれていなかった

---

📌 **注意**  
このテンプレートへの直接記入は禁止です。  
チェック記録はこのファイルをコピーし、必ず `security-checklist.YYYY-MM-DD.md` 形式で保存してください。
